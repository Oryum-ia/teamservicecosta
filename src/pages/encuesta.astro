---
import Layout from '../layouts/Layout.astro';
import HeaderMiro from '../components/HeaderMiro.astro';
import FooterMiro from '../components/FooterMiro.astro';
import WhatsAppButton from '../components/WhatsAppButton.astro';
---

<Layout
  title="Encuesta de Satisfacción | Team Service Costa"
  description="Tu opinión nos ayuda a mejorar. Comparte tu experiencia con nuestros productos y servicios."
>
  <HeaderMiro />

  <main class="encuesta-page">
    <!-- Hero Section -->
    <section class="hero-section">
      <div class="container">
        <span class="hero-badge">TU OPINIÓN CUENTA</span>
        <h1 class="hero-title">Encuesta de Satisfacción</h1>
        <p class="hero-description">
          Queremos conocer tu experiencia con Team Service Costa. Tu opinión es fundamental
          para seguir mejorando nuestros productos y servicios.
        </p>
      </div>
    </section>

    <!-- Form Section -->
    <section class="form-section">
      <div class="container">
        <div class="form-wrapper">
          <form id="encuesta-form" class="encuesta-form">
            <!-- Información Personal -->
            <div class="form-section-header">
              <h2>Información básica</h2>
              <p>Ayúdanos con algunos datos para poder contactarte</p>
            </div>

            <div class="form-grid">
              <div class="form-group">
                <label for="nombre" class="form-label">
                  Nombre completo <span class="required">*</span>
                </label>
                <input
                  type="text"
                  id="nombre"
                  name="nombre"
                  class="form-input"
                  placeholder="Juan Pérez"
                  required
                />
              </div>

              <div class="form-group">
                <label for="email" class="form-label">
                  Correo electrónico <span class="required">*</span>
                </label>
                <input
                  type="email"
                  id="email"
                  name="email"
                  class="form-input"
                  placeholder="correo@ejemplo.com"
                  required
                />
              </div>

              <div class="form-group">
                <label for="telefono" class="form-label">
                  Teléfono
                </label>
                <input
                  type="tel"
                  id="telefono"
                  name="telefono"
                  class="form-input"
                  placeholder="+57 300 123 4567"
                />
              </div>

              <div class="form-group">
                <label for="sede" class="form-label">
                  ¿En qué sede fuiste atendido? <span class="required">*</span>
                </label>
                <select id="sede" name="sede" class="form-input" required>
                  <option value="">Selecciona una sede</option>
                  <option value="monteria">Montería</option>
                  <option value="cartagena">Cartagena</option>
                  <option value="apartado">Apartadó</option>
                </select>
              </div>
            </div>

            <!-- Experiencia de Servicio -->
            <div class="form-section-header">
              <h2>Experiencia de servicio</h2>
              <p>Califica tu experiencia con nosotros</p>
            </div>

            <div class="rating-questions">
              <!-- Atención recibida -->
              <div class="rating-group">
                <label class="rating-label">
                  ¿Cómo calificarías la atención recibida? <span class="required">*</span>
                </label>
                <div class="star-rating" data-question="atencion">
                  <input type="radio" id="atencion-5" name="atencion" value="5" required />
                  <label for="atencion-5" class="star">★</label>
                  <input type="radio" id="atencion-4" name="atencion" value="4" />
                  <label for="atencion-4" class="star">★</label>
                  <input type="radio" id="atencion-3" name="atencion" value="3" />
                  <label for="atencion-3" class="star">★</label>
                  <input type="radio" id="atencion-2" name="atencion" value="2" />
                  <label for="atencion-2" class="star">★</label>
                  <input type="radio" id="atencion-1" name="atencion" value="1" />
                  <label for="atencion-1" class="star">★</label>
                </div>
              </div>

              <!-- Calidad del servicio -->
              <div class="rating-group">
                <label class="rating-label">
                  ¿Cómo calificarías la calidad del servicio técnico? <span class="required">*</span>
                </label>
                <div class="star-rating" data-question="calidad">
                  <input type="radio" id="calidad-5" name="calidad" value="5" required />
                  <label for="calidad-5" class="star">★</label>
                  <input type="radio" id="calidad-4" name="calidad" value="4" />
                  <label for="calidad-4" class="star">★</label>
                  <input type="radio" id="calidad-3" name="calidad" value="3" />
                  <label for="calidad-3" class="star">★</label>
                  <input type="radio" id="calidad-2" name="calidad" value="2" />
                  <label for="calidad-2" class="star">★</label>
                  <input type="radio" id="calidad-1" name="calidad" value="1" />
                  <label for="calidad-1" class="star">★</label>
                </div>
              </div>

              <!-- Tiempo de respuesta -->
              <div class="rating-group">
                <label class="rating-label">
                  ¿Cómo calificarías el tiempo de respuesta? <span class="required">*</span>
                </label>
                <div class="star-rating" data-question="tiempo">
                  <input type="radio" id="tiempo-5" name="tiempo" value="5" required />
                  <label for="tiempo-5" class="star">★</label>
                  <input type="radio" id="tiempo-4" name="tiempo" value="4" />
                  <label for="tiempo-4" class="star">★</label>
                  <input type="radio" id="tiempo-3" name="tiempo" value="3" />
                  <label for="tiempo-3" class="star">★</label>
                  <input type="radio" id="tiempo-2" name="tiempo" value="2" />
                  <label for="tiempo-2" class="star">★</label>
                  <input type="radio" id="tiempo-1" name="tiempo" value="1" />
                  <label for="tiempo-1" class="star">★</label>
                </div>
              </div>

              <!-- Productos/equipos -->
              <div class="rating-group">
                <label class="rating-label">
                  ¿Cómo calificarías los productos/equipos? <span class="required">*</span>
                </label>
                <div class="star-rating" data-question="productos">
                  <input type="radio" id="productos-5" name="productos" value="5" required />
                  <label for="productos-5" class="star">★</label>
                  <input type="radio" id="productos-4" name="productos" value="4" />
                  <label for="productos-4" class="star">★</label>
                  <input type="radio" id="productos-3" name="productos" value="3" />
                  <label for="productos-3" class="star">★</label>
                  <input type="radio" id="productos-2" name="productos" value="2" />
                  <label for="productos-2" class="star">★</label>
                  <input type="radio" id="productos-1" name="productos" value="1" />
                  <label for="productos-1" class="star">★</label>
                </div>
              </div>

              <!-- Satisfacción general -->
              <div class="rating-group">
                <label class="rating-label">
                  ¿Qué tan satisfecho estás con tu experiencia general? <span class="required">*</span>
                </label>
                <div class="star-rating" data-question="satisfaccion">
                  <input type="radio" id="satisfaccion-5" name="satisfaccion" value="5" required />
                  <label for="satisfaccion-5" class="star">★</label>
                  <input type="radio" id="satisfaccion-4" name="satisfaccion" value="4" />
                  <label for="satisfaccion-4" class="star">★</label>
                  <input type="radio" id="satisfaccion-3" name="satisfaccion" value="3" />
                  <label for="satisfaccion-3" class="star">★</label>
                  <input type="radio" id="satisfaccion-2" name="satisfaccion" value="2" />
                  <label for="satisfaccion-2" class="star">★</label>
                  <input type="radio" id="satisfaccion-1" name="satisfaccion" value="1" />
                  <label for="satisfaccion-1" class="star">★</label>
                </div>
              </div>
            </div>

            <!-- Recomendación -->
            <div class="form-section-header">
              <h2>Recomendación</h2>
            </div>

            <div class="form-group full-width">
              <label class="rating-label">
                ¿Recomendarías Team Service Costa a un amigo o colega? <span class="required">*</span>
              </label>
              <div class="recommendation-scale">
                {[...Array(11)].map((_, i) => (
                  <label class="scale-option">
                    <input type="radio" name="recomendacion" value={i} required />
                    <span class="scale-number">{i}</span>
                  </label>
                ))}
              </div>
              <div class="scale-labels">
                <span>Muy improbable</span>
                <span>Muy probable</span>
              </div>
            </div>

            <!-- Comentarios -->
            <div class="form-section-header">
              <h2>Comentarios adicionales</h2>
              <p>¿Hay algo más que quieras compartirnos?</p>
            </div>

            <div class="form-group full-width">
              <label for="comentarios" class="form-label">
                Comentarios o sugerencias
              </label>
              <textarea
                id="comentarios"
                name="comentarios"
                class="form-textarea"
                rows="5"
                placeholder="Cuéntanos sobre tu experiencia, lo que te gustó o lo que podríamos mejorar..."
              ></textarea>
            </div>

            <!-- Submit Button -->
            <div class="form-actions">
              <button type="submit" class="btn-submit">
                Enviar encuesta
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                  <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
              </button>
            </div>
          </form>

          <!-- Success Message -->
          <div id="success-message" class="success-message" style="display: none;">
            <div class="success-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                <path d="M2 17l10 5 10-5"></path>
                <path d="M2 12l10 5 10-5"></path>
              </svg>
            </div>
            <h3>¡Gracias por tu tiempo!</h3>
            <p>Tu opinión es muy valiosa para nosotros y nos ayuda a mejorar cada día. Apreciamos que hayas compartido tu experiencia con Team Service Costa.</p>
            <a href="/" class="btn-secondary">Volver al inicio</a>
          </div>
        </div>

        <!-- Toast Notification -->
        <div id="toast-notification" class="toast-notification">
          <div class="toast-icon"></div>
          <div class="toast-content">
            <p class="toast-title"></p>
            <p class="toast-message"></p>
          </div>
          <button class="toast-close">&times;</button>
        </div>

        <!-- Info Banner -->
        <div class="info-banner">
          <div class="banner-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="16" x2="12" y2="12"></line>
              <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
          </div>
          <div class="banner-content">
            <h3>Tu privacidad es importante</h3>
            <p>Toda la información que compartas será tratada de forma confidencial y solo será utilizada para mejorar nuestros servicios.</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <FooterMiro />
  <WhatsAppButton
    phone="+573205085531"
    message="Hola, tengo una pregunta sobre la encuesta de satisfacción"
  />
</Layout>

<style>
  .encuesta-page {
    min-height: 100vh;
    padding-top: 0;
    margin-top: 0;
  }

  .container {
    max-width: 900px;
    margin: 0 auto;
    padding: 0 var(--spacing-4);
  }

  /* Hero Section */
  .hero-section {
    background: linear-gradient(135deg, #0F172A 0%, #1E293B 50%, #334155 100%);
    color: white;
    padding: var(--spacing-8) 0 var(--spacing-8);
    text-align: center;
    position: relative;
    overflow: hidden;
    margin-top: 0;
    margin-bottom: 0;
  }

  .hero-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at 30% 40%, rgba(255, 208, 47, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 70% 70%, rgba(66, 98, 255, 0.15) 0%, transparent 50%);
    pointer-events: none;
  }

  .hero-section .container {
    position: relative;
    z-index: 1;
  }

  .hero-badge {
    display: inline-block;
    background: linear-gradient(135deg, #FFD700 0%, #FFC700 100%);
    color: #1a1a2e;
    padding: var(--spacing-2) var(--spacing-6);
    border-radius: var(--radius-full);
    font-size: var(--text-sm);
    font-weight: var(--font-bold);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: var(--spacing-4);
    box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
  }

  .hero-title {
    font-size: 3.5rem;
    font-weight: var(--font-extrabold);
    margin: var(--spacing-4) 0;
    line-height: 1.1;
    letter-spacing: -0.03em;
    background: linear-gradient(135deg, #FFFFFF 0%, #E2E8F0 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .hero-description {
    font-size: var(--text-lg);
    line-height: 1.8;
    color: rgba(255, 255, 255, 0.9);
    max-width: 700px;
    margin: 0 auto;
  }

  /* Form Section */
  .form-section {
    padding: var(--spacing-20) 0;
    background: linear-gradient(180deg, #f8f9fa 0%, #ffffff 100%);
  }

  .form-wrapper {
    background: white;
    border-radius: var(--radius-2xl);
    padding: var(--spacing-12);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08), 0 0 1px rgba(0, 0, 0, 0.1);
    margin-bottom: var(--spacing-8);
    border: 1px solid rgba(255, 215, 0, 0.1);
  }

  .form-section-header {
    margin-bottom: var(--spacing-8);
    padding-bottom: var(--spacing-6);
    border-bottom: 2px solid var(--color-gray-100);
  }

  .form-section-header h2 {
    font-size: var(--text-2xl);
    color: #1a1a2e;
    margin-bottom: var(--spacing-2);
  }

  .form-section-header p {
    font-size: var(--text-base);
    color: var(--color-gray-600);
    margin: 0;
  }

  .form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--spacing-6);
    margin-bottom: var(--spacing-10);
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-2);
  }

  .form-group.full-width {
    grid-column: 1 / -1;
  }

  .form-label,
  .rating-label {
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    color: #1a1a2e;
  }

  .required {
    color: #ef4444;
  }

  .form-input,
  .form-textarea {
    padding: var(--spacing-3) var(--spacing-4);
    border: 2px solid var(--color-gray-200);
    border-radius: var(--radius-lg);
    font-size: var(--text-base);
    font-family: var(--font-primary);
    transition: all 0.2s ease;
    background: var(--color-white);
  }

  .form-input:focus,
  .form-textarea:focus {
    outline: none;
    border-color: #FFD700;
    box-shadow: 0 0 0 4px rgba(255, 215, 0, 0.15);
  }

  .form-textarea {
    resize: vertical;
    min-height: 120px;
  }

  /* Star Rating */
  .rating-questions {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-8);
    margin-bottom: var(--spacing-10);
  }

  .rating-group {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-3);
  }

  .star-rating {
    display: flex;
    flex-direction: row-reverse;
    justify-content: flex-end;
    gap: var(--spacing-2);
  }

  .star-rating input {
    display: none;
  }

  .star-rating .star {
    font-size: 2.5rem;
    color: var(--color-gray-300);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .star-rating input:checked ~ .star,
  .star-rating .star:hover,
  .star-rating .star:hover ~ .star {
    color: #FFD700;
    transform: scale(1.1);
  }

  .star-rating .star:hover {
    filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.5));
  }

  /* Recommendation Scale */
  .recommendation-scale {
    display: flex;
    gap: var(--spacing-2);
    justify-content: space-between;
    margin: var(--spacing-4) 0 var(--spacing-2);
  }

  .scale-option {
    flex: 1;
    cursor: pointer;
  }

  .scale-option input {
    display: none;
  }

  .scale-number {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 48px;
    border: 2px solid var(--color-gray-300);
    border-radius: var(--radius-lg);
    font-weight: var(--font-semibold);
    transition: all 0.2s ease;
    background: white;
  }

  .scale-option input:checked + .scale-number {
    background: linear-gradient(135deg, #FFD700 0%, #FFC700 100%);
    border-color: #FFD700;
    color: #1a1a2e;
    box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
    transform: scale(1.05);
  }

  .scale-option:hover .scale-number {
    border-color: #FFD700;
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.05) 0%, rgba(255, 215, 0, 0.1) 100%);
  }

  .scale-labels {
    display: flex;
    justify-content: space-between;
    font-size: var(--text-xs);
    color: var(--color-gray-500);
    font-weight: var(--font-medium);
  }

  /* Buttons */
  .form-actions {
    margin-top: var(--spacing-8);
    display: flex;
    justify-content: center;
  }

  .btn-submit {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    background: linear-gradient(135deg, #FFD700 0%, #FFC700 100%);
    color: #1a1a2e;
    padding: var(--spacing-4) var(--spacing-10);
    border: none;
    border-radius: var(--radius-lg);
    font-size: var(--text-lg);
    font-weight: var(--font-bold);
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 8px 24px rgba(255, 215, 0, 0.35);
    position: relative;
    overflow: hidden;
  }

  .btn-submit::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: left 0.5s ease;
  }

  .btn-submit:hover::before {
    left: 100%;
  }

  .btn-submit:hover {
    background: linear-gradient(135deg, #FFC700 0%, #FFB700 100%);
    transform: translateY(-2px);
    box-shadow: 0 12px 32px rgba(255, 215, 0, 0.45);
  }

  .btn-submit svg {
    position: relative;
    z-index: 1;
  }

  /* Success Message */
  .success-message {
    text-align: center;
    padding: var(--spacing-16) var(--spacing-8);
  }

  .success-icon {
    color: #10b981;
    margin-bottom: var(--spacing-6);
  }

  .success-message h3 {
    font-size: var(--text-3xl);
    color: #1a1a2e;
    margin-bottom: var(--spacing-4);
  }

  .success-message p {
    font-size: var(--text-lg);
    color: var(--color-gray-600);
    max-width: 500px;
    margin: 0 auto var(--spacing-8);
  }

  .btn-secondary {
    display: inline-block;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    color: #FFD700;
    padding: var(--spacing-3) var(--spacing-8);
    border-radius: var(--radius-lg);
    font-size: var(--text-base);
    font-weight: var(--font-semibold);
    text-decoration: none;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(26, 26, 46, 0.2);
  }

  .btn-secondary:hover {
    background: linear-gradient(135deg, #16213e 0%, #0f3460 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(26, 26, 46, 0.3);
  }

  /* Info Banner */
  .info-banner {
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.12) 0%, rgba(255, 215, 0, 0.06) 100%);
    border: 2px solid rgba(255, 215, 0, 0.3);
    border-radius: var(--radius-xl);
    padding: var(--spacing-6);
    display: flex;
    gap: var(--spacing-4);
    align-items: flex-start;
    box-shadow: 0 4px 12px rgba(255, 215, 0, 0.1);
  }

  .banner-icon {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.2) 0%, rgba(255, 215, 0, 0.1) 100%);
    color: #FFD700;
    border-radius: var(--radius-full);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .banner-content h3 {
    font-size: var(--text-lg);
    color: #1a1a2e;
    margin-bottom: var(--spacing-2);
    font-weight: var(--font-bold);
  }

  .banner-content p {
    font-size: var(--text-sm);
    color: var(--color-gray-600);
    margin: 0;
    line-height: 1.6;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .hero-title {
      font-size: var(--text-4xl);
    }

    .form-wrapper {
      padding: var(--spacing-6);
    }

    .form-grid {
      grid-template-columns: 1fr;
    }

    .recommendation-scale {
      flex-wrap: wrap;
    }

    .scale-option {
      min-width: calc(20% - var(--spacing-2));
    }

    .star-rating .star {
      font-size: 2rem;
    }

    .btn-submit {
      width: 100%;
      justify-content: center;
    }

    .toast-notification {
      left: 10px;
      right: 10px;
      min-width: auto;
    }
  }

  /* Toast Notification (copiado de PQR) */
  .toast-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
    padding: var(--spacing-4);
    display: none;
    align-items: center;
    gap: var(--spacing-3);
    min-width: 320px;
    max-width: 420px;
    z-index: 9999;
    animation: slideInRight 0.3s ease-out;
  }

  .toast-notification.show {
    display: flex;
  }

  .toast-notification.success {
    border-left: 4px solid #10b981;
  }

  .toast-notification.error {
    border-left: 4px solid #ef4444;
  }

  @keyframes slideInRight {
    from { transform: translateX(400px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  @keyframes slideOutRight {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(400px); opacity: 0; }
  }

  .toast-notification.hide {
    animation: slideOutRight 0.3s ease-in forwards;
  }

  .toast-icon {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .toast-notification.success .toast-icon {
    background: #10b981;
  }

  .toast-notification.error .toast-icon {
    background: #ef4444;
  }

  .toast-icon::before {
    content: '✓';
    color: white;
    font-size: 16px;
    font-weight: bold;
  }

  .toast-notification.error .toast-icon::before {
    content: '✕';
  }

  .toast-content {
    flex: 1;
  }

  .toast-title {
    font-weight: var(--font-semibold);
    color: #1a1a2e;
    margin: 0 0 var(--spacing-1);
    font-size: var(--text-base);
  }

  .toast-message {
    color: var(--color-gray-600);
    margin: 0;
    font-size: var(--text-sm);
  }

  .toast-close {
    background: none;
    border: none;
    font-size: 24px;
    color: var(--color-gray-400);
    cursor: pointer;
    padding: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: color 0.2s;
  }

  .toast-close:hover {
    color: var(--color-gray-600);
  }
</style>

<script>
  import { supabase } from '../lib/supabase';

  const form = document.getElementById('encuesta-form') as HTMLFormElement;
  const successMessage = document.getElementById('success-message');

  // Función para mostrar notificaciones toast
  function showToast(type: 'success' | 'error', title: string, message: string) {
    const toast = document.getElementById('toast-notification');
    const toastTitle = toast?.querySelector('.toast-title');
    const toastMessage = toast?.querySelector('.toast-message');
    const toastClose = toast?.querySelector('.toast-close');

    if (!toast || !toastTitle || !toastMessage) return;

    toast.classList.remove('success', 'error', 'show', 'hide');
    toast.classList.add(type);

    toastTitle.textContent = title;
    toastMessage.textContent = message;

    toast.classList.add('show');

    const hideTimeout = setTimeout(() => {
      hideToast();
    }, 5000);

    const closeHandler = () => {
      clearTimeout(hideTimeout);
      hideToast();
      toastClose?.removeEventListener('click', closeHandler);
    };

    toastClose?.addEventListener('click', closeHandler);

    function hideToast() {
      toast.classList.add('hide');
      setTimeout(() => {
        toast.classList.remove('show', 'hide');
      }, 300);
    }
  }

  if (form && successMessage) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Get form data
      const formData = new FormData(form);

      // Deshabilitar el botón de envío
      const submitBtn = form.querySelector('button[type="submit"]');
      const originalBtnText = submitBtn?.textContent;
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Enviando...';
      }

      try {
        // Preparar datos para insertar
        const encuestaData = {
          nombre_completo: formData.get('nombre') || formData.get('nombre_completo'),
          email: formData.get('email') as string,
          telefono: (formData.get('telefono') as string) || null,
          sede: formData.get('ubicacion') || formData.get('sede'),
          atencion_calificacion: parseInt(formData.get('servicio_atencion') as string),
          calidad_calificacion: parseInt(formData.get('servicio_tecnico') as string),
          tiempo_calificacion: parseInt(formData.get('tiempo_respuesta') as string),
          productos_calificacion: parseInt(formData.get('calidad_producto') as string),
          satisfaccion_general: parseInt(formData.get('satisfaccion_general') as string),
          recomendacion_puntuacion: parseInt(formData.get('recomendacion') as string),
          comentarios: (formData.get('comentarios') as string) || null,
          ip_address: null, // El navegador no puede obtener la IP real
          user_agent: navigator.userAgent
        };

        // Validar que las calificaciones estén en el rango correcto
        const calificaciones = [
          { nombre: 'Atención al cliente', valor: encuestaData.atencion_calificacion, min: 1, max: 5 },
          { nombre: 'Servicio técnico', valor: encuestaData.calidad_calificacion, min: 1, max: 5 },
          { nombre: 'Tiempo de respuesta', valor: encuestaData.tiempo_calificacion, min: 1, max: 5 },
          { nombre: 'Calidad del producto', valor: encuestaData.productos_calificacion, min: 1, max: 5 },
          { nombre: 'Satisfacción general', valor: encuestaData.satisfaccion_general, min: 1, max: 5 },
          { nombre: 'Recomendación', valor: encuestaData.recomendacion_puntuacion, min: 0, max: 10 }
        ];

        for (const cal of calificaciones) {
          if (isNaN(cal.valor) || cal.valor < cal.min || cal.valor > cal.max) {
            showToast('error', 'Calificación inválida', `Por favor selecciona una calificación válida para: ${cal.nombre}`);
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.textContent = originalBtnText || 'Enviar Encuesta';
            }
            return;
          }
        }

        // Insertar en Supabase
        const { data, error } = await supabase
          .from('encuestas')
          .insert([encuestaData])
          .select()
          .single();

        if (error) {
          console.error('Error al insertar encuesta:', error);

          // Si es un error de email duplicado
          if (error.code === '23505' && error.message.includes('encuestas_email_key')) {
            showToast('error', 'Email duplicado', 'Ya existe una encuesta registrada con este correo electrónico.');
          } else {
            showToast('error', 'Error al enviar', 'No se pudo guardar tu encuesta. Por favor intenta nuevamente.');
          }

          // Rehabilitar botón
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = originalBtnText || 'Enviar Encuesta';
          }
          return;
        }

        // Mostrar notificación de éxito
        showToast('success', '¡Encuesta enviada!', 'Gracias por compartir tu opinión con nosotros.');

        // Hide form and show success message
        form.style.display = 'none';
        successMessage.style.display = 'block';

        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });

        // Redirigir después de 3 segundos
        setTimeout(() => {
          window.location.href = '/';
        }, 3000);

      } catch (error) {
        console.error('Error al enviar encuesta:', error);
        showToast('error', 'Error de conexión', 'No se pudo conectar con el servidor. Por favor verifica tu conexión a internet.');

        // Rehabilitar botón
        if (submitBtn) {
          (submitBtn as HTMLButtonElement).disabled = false;
          submitBtn.textContent = originalBtnText || 'Enviar Encuesta';
        }
      }
    });
  }
</script>
